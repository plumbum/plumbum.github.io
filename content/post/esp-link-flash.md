+++
date = "2016-03-15T11:59:38+03:00"
description = "Прошивка готовoй сборки ESP-Link"
draft = false
tags = ["ESP8266", "Serial", "Telnet", "Bridge", "Flash", "Firmware"]
title = "Прошивка ESP-Link"
topics = []

+++

[ESP-Link](https://github.com/jeelabs/esp-link) - это WiFi-Serial мост на базе SoC ESP8266.
Кроме моста имеются дополнительные плюшки как то:

  * Отправка REST запросов.
  * Клиент MQTT протокола.
  * Программатор AVR и LPC микроконтроллеров, а так же других модулей ESP8266 (по последовательному порту).

В данный момент стабильной является прошивка версии [2.1.7](https://github.com/jeelabs/esp-link/releases/tag/v2.1.7)
и самым простым вариантом установки будет взять собранные бинарные файлы и прошить их в модуль.

Поддерживаются как модули с 512 Кбайт флеш-памяти (например ESP-01, ESP-07) так и модули с 4 Мбайт флеш-памяти (например ESP-12).

В общем и целом, ограничений на типы модулей нет, ESP-Link успешно конфигурируется под разные GPIO через Web-интерфейс.


## Прошивка

Для прошивки нам потребуется утилита [ESPTool](https://github.com/themadinventor/esptool).

Для себя я не стал её инсталлировать в систему, а просто скопировал [esptool.py](https://github.com/themadinventor/esptool/blob/master/esptool.py)
в `~/bin`, а библиотеку [pyserial](https://github.com/pyserial/pyserial) поставил через пакетный менеджер дистрибутива.

На [странице релизов](https://github.com/jeelabs/esp-link/releases) скачиваем
последнюю [стабильную прошивку](https://github.com/jeelabs/esp-link/releases/tag/v2.1.7)
или [бету](https://github.com/jeelabs/esp-link/releases/tag/v2.2.beta2), если есть желание поэкспериментировать.

Распаковываем полученный файл:

```
tar xzvf esp-link-v2.1.7.tgz
cd esp-link-v2.1.7
```

Подключаем прошиваемый модуль к компьютеру через Usb-TTLSerial переходник. Следует помнить, что выходы TX-RX
переходника должны выдавать напряжение от 0 до 3.3 вольт. Переходники с напряжением 5 вольт, могут безвозвратно
повредить модуль.

Для нормальной работы модуля вывод `CH_PD` должен быть подтянут к питанию через резистор 1-10 Ком,
вывод `GPIO15` должен быть подтянут к земле через резистор 1-10 Ком.

![ESP](/img/esp/ESP_min.png) [Minimal](http://esp8266.github.io/Arduino/versions/2.1.0-rc2/doc/boards.html#minimal)

Для входа в режим программирования следует подтянуть выход `GPIO0` к земле через резистор 1-10 Ком,
и произвести сброс контроллера кратковременной подачей низкого уровня на вход `RESET`.

После этого модуль готов к прошивке.

Для версии с 4 Мбайтами флеш-памяти выполняем команду:

```
esptool.py --port /dev/ttyUSB0 --baud 460800 write_flash -fs 32m -ff 80m \
    0x00000 boot_v1.4\(b1\).bin 0x1000 user1.bin 0x3FE000 blank.bin
```

Для версии с 512 Кбайтами флеш-памяти выполняем команду:

```
esptool.py --port /dev/ttyUSB0 --baud 460800 write_flash -fs 4m -ff 40m \
    0x00000 boot_v1.4\(b1\).bin 0x1000 user1.bin 0x7E000 blank.bin
```

Если возникли проблемы в процессе прошивки то можно попробовать снизить скорость обмена по последовательному порту `--baud 115200`
и/или скорость обмена с SPI-flash `-ff 20m`.

После успешной прошивки модуль доступен по сети WiFi как точка доступа.

Если ранее модуль уже был прошит как esp-link, то обновление прошивки можно провести по воздуху:

```
./wiflash <esp-hostname> user1.bin user2.bin
```

